\documentclass[aspectratio=169, 14pt]{beamer}
\usepackage[]{xcolor}
\usepackage{multicol}
\usepackage{tikz}
\usepackage{subfig}
\title{Using Pseudo-Random Numbers Repeatably in a Fine-Grain Multithreaded Simulation}
\author{Dmitry Savin\\
supervised by John Apostolakis and Sandro Wenzel}
\date{\today}

\usepackage[utf8]{inputenc}

\setbeamersize{text margin left=0pt,text margin right=0pt}

\begin{document}
\begin{large}

 \frame{\titlepage}


 \begin{frame}{Motivation}
 \large
  \begin{itemize}
   \item Monte Carlo simulation relies on pseudo-random numbers
   \item The numbers must seem uncorrelated
   \item Reproducibility from any point of simulation is needed
  \end{itemize}
 \end{frame}
 
  \begin{frame}{Motivation}
  \large
  \begin{itemize}
   \item Geant4 uses event-level parallelism
   \begin{itemize}
     \item Each event is simulated independently
     \item Independent PRNGs in a small fixed number of threads
    \end{itemize}
    $\Rightarrow$ an event is defined by the generator state at the beginning\\ \ \\
   \item GeantV uses track-level parallelism
    \begin{itemize}
     \item Similar tracks from many events are collected in "baskets"
     \item Baskets are processed in parallel to utilize vectorisation
     \item A big number of tracks is needed to reduce overhead
     \item Number of tracks, baskets and threads change during the simulation
    \end{itemize}
   $\Rightarrow$ the generator state must be associated with the track
  \end{itemize}

 \end{frame}

 
 \begin{frame}{Pedigrees}
  \begin{itemize}
   \item the rank of a track - the number of sibling tracks created by its parent track before it
   \item the pedigree of a track - the sequence of ranks of its ancestor tracks
   \item the hashed pedigree can be stored by the track and used to seed the generator
  \end{itemize}
 \end{frame}


 \begin{frame}{Merkle–Damgård hash calculation}
  \begin{figure}
   \scalebox{.5}{\input{damgard}}
  \end{figure}
 \end{frame}

 \begin{frame}{Random number engines}
   \begin{multicols}{2}
   \begin{itemize}
    \item Ranecu
    \item Ranlux
    \item Ranlux64
    \item HepJamesRandom
    \item Ranshi
    \item DualRand
    \item Mersenne Twister
    \item MixMax
    \item CBPRNG
   \end{itemize}
  \end{multicols}
 \end{frame}
%  
 \begin{frame}{Counter-Based Pseudo-Random Number Generators}
  \begin{itemize}
   \item CPRNG state transition function is a simple increment
   \item The randomness is produces by the output function
   \item Seeding is a single assignment
   \item A cryptographic function can be used as the output function
   \item Faster functions can be used under relaxed requirements
   \item Random123 library provides a set of such functions
   \item Philox1x64, Threefry1x64 were wrapped in a CLHEP interface
   \item Vectorization may increase performance
  \end{itemize}
 \end{frame} 
 
 \begin{frame}{MixMax}
  \begin{itemize}
   \item MixMax passes the BigCrush test suite
   \item MixMax has several implementations with different state size
   \item In Geant4 10.04 beta the state size is 17
   \item MixMax has several seeding mechanisms
  \end{itemize}
 \end{frame}
 
 \begin{frame}{CLHEP engines}
    Ranecu, Ranlux, HepJamesRandom, Ranshi, DualRand - legacy engines kept for compatibility and should not be used.
    \\ \textcolor{red}{ - Not indicated in the manual!}\\
    HepJamesRandom is the default, and Ranecu is used in many examples $\Rightarrow$ get in the user code.\\ \ \\
    Ranlux64 is good enough, but slower than others.\\
    MTwister is the currently recommended Geant4 engine and passes most of the tests, but not all
 \end{frame}
 
 \begin{frame}{Test example}
  Hadr06 and graphite.mac ith 10x events were used
  \begin{itemize}
   \item Incident neutrons require many random numbers for thermal nucleus sampling
   \item 20cm graphite sphere doesn't slow neutrons to thermal energy, so many inelastic interactions per scattering
   \item Well-known 4.4 MeV peak in the outgoing gamma spectra.
  \end{itemize}
 \end{frame}

 \begin{frame}{Physical results}
  \begin{figure}
   \label{GAMMASPECTRUM}
   \scalebox{.6}{\input{graphiteGamma}}
   \caption*{Neutron induced gamma spectrum from a graphite sample with different random engines.}
  \end{figure}
 \end{frame}

 \begin{frame}{Performance}
  \begin{figure}
   \begin{subfloat}[][]
    \centering
    \scalebox{.33}{\input{mean}}  
% %    \caption{Caption A}
%     \label{fig:A}
   \end{subfloat}
   \begin{subfloat}[][]
    \centering
    \scalebox{.33}{\input{smallMean}}  
%    \caption{Caption B}
    \label{fig:B}
   \end{subfloat}
  \end{figure}
 \end{frame}

 
 \begin{frame}{Conclusion}
  \begin{itemize}
   \item Implemented a Geant4 prototype which can perform fully reproducible simulations in a multithreaded environment and under the exchange of the order of track propagation.
   \item Profiled the overhead to achieve this reproducibility for different random number engines and showed that it is quite low for selected engines.
  
   \item \bf It is worth to apply a similar algorithm for reproducible pseudo-random number generation in GeantV.
  \end{itemize}

 \end{frame}
 
 \begin{frame}{Acknowledgements}

  \centering
  I would like to thank\\
  John Apostolakis and Sandro Wenzel\\
  for productive collaboration. 

 \end{frame}
 
 
 \appendix
 
 \end{large}
\end{document}
